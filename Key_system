-- 防止重复运行（带通知+提示音）
if getgenv().EthanHubLoaded or getgenv().KeySystemLoaded then
    game.StarterGui:SetCore("SendNotification", {
        Title = "Ethan 脚本中心",
        Text = "脚本中心或卡密系统已加载，无需重复运行！",
        Duration = 5
    })
    local Sound = Instance.new("Sound")
    Sound.Parent = game.SoundService
    Sound.SoundId = "rbxassetid://550209561"
    Sound.Volume = 5
    Sound.PlayOnRemove = true
    Sound:Destroy()
    return
end
getgenv().KeySystemLoaded = true -- 标记卡密系统已打开

-- ===== 从云端获取 config.lua（带重试机制） =====
local config
local maxRetries = 3
local success = false

for attempt = 1, maxRetries do
    local ok, result = pcall(function()
        return loadstring(game:HttpGet(
            "https://raw.githubusercontent.com/jgyugu/Template-Script-Hub/refs/heads/main/config.lua"
        ))()
    end)
    if ok and type(result) == "table" then
        config = result
        success = true
        break
    else
        warn(string.format("[EthanHub] 获取配置失败（第 %d 次），正在重试...", attempt))
        task.wait(1)
    end
end

if not success then
    game.StarterGui:SetCore("SendNotification", {
        Title = "Ethan 脚本中心",
        Text = "无法获取配置，请检查你的网络连接！",
        Duration = 5
    })
    getgenv().KeySystemLoaded = false -- 获取失败时重置标记
    return
end

local correctKey = config.key or "key"
local scriptHubURL = config.scriptHubURL or "https://raw.githubusercontent.com/jgyugu/Template-Script-Hub/refs/heads/main/menu.lua"

-- ===== 创建卡密验证 UI =====
local parentGui = game:GetService("CoreGui")
pcall(function()
    if typeof(gethui) == "function" then
        parentGui = gethui()
    end
end)

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KeySystem"
ScreenGui.Parent = parentGui
ScreenGui.ResetOnSpawn = false

local Frame = Instance.new("Frame")
Frame.Parent = ScreenGui
Frame.Size = UDim2.new(0, 300, 0, 180)
Frame.Position = UDim2.new(0.5, -150, 0.5, -90)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.BorderSizePixel = 0
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 8)

local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Title.BorderSizePixel = 0
Title.Text = "Ethan 脚本中心卡密系统"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamSemibold
Title.TextSize = 18

-- 拖动逻辑
local UserInputService = game:GetService("UserInputService")
local dragging, dragInput, dragStart, startPos
local function update(input)
    local delta = input.Position - dragStart
    Frame.Position = UDim2.new(
        startPos.X.Scale, startPos.X.Offset + delta.X,
        startPos.Y.Scale, startPos.Y.Offset + delta.Y
    )
end
Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)
Title.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- 关闭按钮（关闭时重置标记）
local CloseBtn = Instance.new("TextButton", Frame)
CloseBtn.Size = UDim2.new(0, 28, 0, 28)
CloseBtn.Position = UDim2.new(1, -34, 0, 6)
CloseBtn.Text = "×"
CloseBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 16
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0, 6)
CloseBtn.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
    getgenv().KeySystemLoaded = false -- 关闭时重置标记
end)

-- 输入框
local KeyBox = Instance.new("TextBox", Frame)
KeyBox.Size = UDim2.new(1, -20, 0, 40)
KeyBox.Position = UDim2.new(0, 10, 0, 60)
KeyBox.PlaceholderText = "在此输入卡密"
KeyBox.Text = ""
KeyBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
KeyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyBox.Font = Enum.Font.Gotham
KeyBox.TextSize = 16
Instance.new("UICorner", KeyBox).CornerRadius = UDim.new(0, 6)

-- 提示文本
local StatusLabel = Instance.new("TextLabel", Frame)
StatusLabel.Size = UDim2.new(1, -20, 0, 20)
StatusLabel.Position = UDim2.new(0, 10, 0, 110)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = ""
StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 14
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

-- 确认按钮
local ConfirmBtn = Instance.new("TextButton", Frame)
ConfirmBtn.Size = UDim2.new(1, -20, 0, 35)
ConfirmBtn.Position = UDim2.new(0, 10, 0, 140)
ConfirmBtn.Text = "验证"
ConfirmBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
ConfirmBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ConfirmBtn.Font = Enum.Font.GothamBold
ConfirmBtn.TextSize = 16
Instance.new("UICorner", ConfirmBtn).CornerRadius = UDim.new(0, 6)

-- 验证逻辑（成功时直接销毁按钮和输入框 + 重置标记）
local function verifyAndLoad()
    if KeyBox.Text == correctKey then
        getgenv().EthanHubLoaded = true
        getgenv().KeySystemLoaded = false -- 重置标记

        -- 直接销毁按钮和输入框
        ConfirmBtn:Destroy()
        KeyBox:Destroy()

        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        StatusLabel.Text = "验证成功！正在加载..."

        task.wait(1)
        ScreenGui:Destroy()
        loadstring(game:HttpGet(scriptHubURL))()
    else
        StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        StatusLabel.Text = "卡密错误，请重试"
        local Sound = Instance.new("Sound")
        Sound.Parent = game.SoundService
        Sound.SoundId = "rbxassetid://550209561"
        Sound.Volume = 5
        Sound.PlayOnRemove = true
        Sound:Destroy()
    end
end

ConfirmBtn.MouseButton1Click:Connect(verifyAndLoad)
KeyBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        verifyAndLoad()
    end
end)
